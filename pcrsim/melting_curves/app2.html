<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DNA Melting Curve Simulator</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: sans-serif; margin: 20px; }
  input, button { margin: 5px; }
  #chartContainer { width: 80%; max-width: 700px; }
</style>
</head>
<body>
<h1>DNA Melting Curve Simulator</h1>
<p>Enter a DNA sequence and adjust parameters:</p>
<label>DNA Sequence: <input type="text" id="seq" value="ATGCGCGTTAGC" size="40"></label><br>
<label>Na⁺ concentration (M): <input type="number" id="na" value="0.05" step="0.001"></label><br>
<label>Mg²⁺ concentration (M): <input type="number" id="mg" value="0.005" step="0.001"></label><br>
<label>Start Temp (°C): <input type="number" id="tStart" value="40" step="1"></label>
<label>End Temp (°C): <input type="number" id="tEnd" value="95" step="1"></label>
<label>Step (°C): <input type="number" id="tStep" value="1" step="0.1"></label><br>
<button id="compute">Compute Melt Curve</button>
<h3>Melting Curve and Derivative:</h3>
<div id="chartContainer"><canvas id="meltChart"></canvas></div>
<script>
const NN_PARAMS = {
  'AA': { dH: -7.9, dS: -22.2 }, 'TT': { dH: -7.9, dS: -22.2 },
  'AT': { dH: -7.2, dS: -20.4 }, 'TA': { dH: -7.2, dS: -21.3 },
  'CA': { dH: -8.5, dS: -22.7 }, 'TG': { dH: -8.5, dS: -22.7 },
  'GT': { dH: -8.4, dS: -22.4 }, 'AC': { dH: -8.4, dS: -22.4 },
  'CT': { dH: -7.8, dS: -21.0 }, 'AG': { dH: -7.8, dS: -21.0 },
  'CG': { dH: -10.6, dS: -27.2 }, 'GC': { dH: -9.8, dS: -24.4 },
  'GG': { dH: -8.0, dS: -19.9 }, 'CC': { dH: -8.0, dS: -19.9 }
};
const R = 1.987e-3;

function calcBaseThermo(seq, saltNa=0.05, Mg2=0.0) {
  let N = seq.length;
  let dH = new Array(N).fill(0);
  let dS = new Array(N).fill(0);
  for (let i = 0; i < N - 1; i++) {
    let dinuc = seq[i] + seq[i+1];
    if (NN_PARAMS[dinuc]) {
      dH[i] += NN_PARAMS[dinuc].dH;
      dS[i] += NN_PARAMS[dinuc].dS;
      dH[i+1] += NN_PARAMS[dinuc].dH;
      dS[i+1] += NN_PARAMS[dinuc].dS;
    }
  }
  const lnNa = Math.log(Math.max(saltNa,1e-9));
  const lnMg = Math.log(Math.max(Mg2,1e-9));
  const sCorr = 0.368 * lnNa + 0.1 * lnMg;
  dS = dS.map(s => s + sCorr);
  return { dH, dS };
}

function meltProbFromThermo(dH,dS,T){
  let dS_kcal = dS/1000;
  let dG = dH - T*dS_kcal;
  let x = dG/(R*T);
  if(x>50)x=50;
  if(x<-50)x=-50;
  return 1/(1+Math.exp(-x));
}

function hmmForwardBackward(emissions, alpha=0.05, pi_m=0.5){
  let N=emissions.length;
  let f=Array.from({length:N},()=>[0,0]);
  let b=Array.from({length:N},()=>[0,0]);
  let stay=1-alpha, trans=alpha;
  f[0][0]=(1-pi_m)*(1-emissions[0]); f[0][1]=pi_m*emissions[0];
  for(let i=1;i<N;i++){
    for(let s=0;s<2;s++){
      let e = s===1?emissions[i]:1-emissions[i];
      f[i][s]=e*(f[i-1][s]*stay + f[i-1][1-s]*trans);
    }
    let norm=f[i][0]+f[i][1]; f[i][0]/=norm; f[i][1]/=norm;
  }
  b[N-1][0]=1; b[N-1][1]=1;
  for(let i=N-2;i>=0;i--){
    for(let s=0;s<2;s++){
      b[i][s]=(s===0?1-emissions[i+1]:emissions[i+1])*(b[i+1][s]*stay + b[i+1][1-s]*trans);
    }
    let norm=b[i][0]+b[i][1]; b[i][0]/=norm; b[i][1]/=norm;
  }
  let post=[];
  for(let i=0;i<N;i++){
    let p0=f[i][0]*b[i][0], p1=f[i][1]*b[i][1], norm=p0+p1;
    post.push(p1/norm);
  }
  return post;
}

function computeFractionMelt(seq,T_C,na,Mg2){
  let {dH,dS}=calcBaseThermo(seq,na,Mg2);
  let T_K=T_C+273.15;
  let emissions=seq.split('').map((_,i)=>meltProbFromThermo(dH[i],dS[i],T_K));
  let meltMap=hmmForwardBackward(emissions);
  return meltMap.reduce((a,b)=>a+b,0)/meltMap.length;
}

document.getElementById('compute').addEventListener('click',()=>{
  let seq=document.getElementById('seq').value.toUpperCase();
  let na=parseFloat(document.getElementById('na').value);
  let mg=parseFloat(document.getElementById('mg').value);
  let tStart=parseFloat(document.getElementById('tStart').value);
  let tEnd=parseFloat(document.getElementById('tEnd').value);
  let tStep=parseFloat(document.getElementById('tStep').value);

  let temps=[], melts=[];
  for(let T=tStart;T<=tEnd;T+=tStep){
    temps.push(T);
    melts.push(computeFractionMelt(seq,T,na,mg));
  }

  // Compute first derivative using finite differences
  let deriv=[];
  for(let i=1;i<melts.length;i++){
    deriv.push((melts[i]-melts[i-1])/(temps[i]-temps[i-1]));
  }
  // Use midpoints for derivative x-axis
  let derivTemps=[];
  for(let i=1;i<temps.length;i++) derivTemps.push((temps[i]+temps[i-1])/2);

  let ctx=document.getElementById('meltChart').getContext('2d');
  if(window.meltChart && typeof window.meltChart.destroy==='function') window.meltChart.destroy();

  window.meltChart=new Chart(ctx,{
    type:'line',
    data:{
      labels:temps,
      datasets:[
        {label:'Fraction Melted', data:melts, borderColor:'red', fill:false},
        {label:'d(Fraction Melted)/dT', data:deriv, borderColor:'blue', fill:false, yAxisID:'y1', labels:derivTemps}
      ]
    },
    options:{
      scales:{
        x:{title:{display:true,text:'Temperature (°C)'}},
        y:{title:{display:true,text:'Fraction Melted'}, min:0, max:1},
        y1:{type:'linear', position:'right', title:{display:true,text:'Derivative'}, min:0}
      }
    }
  });
});
</script>
</body>
</html>
