<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DNA Melting Curve Simulator (Library-based)</title>
  <style>
    :root {
      --bg: #0f172a; --panel: #111827; --muted: #9ca3af;
      --text: #e5e7eb; --accent: #38bdf8; --warn: #ef4444;
    }
    body {
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .wrap { max-width:1100px; margin:24px auto; padding:0 16px; }
    h1 { font-size:28px; margin:10px 0 4px; }
    .sub { color:var(--muted); margin-bottom:18px; }
    .grid { display:grid; grid-template-columns:360px 1fr; gap:18px; }
    .card {
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.08); border-radius:16px;
    }
    .hd { padding:14px 16px; border-bottom:1px solid rgba(255,255,255,0.06); font-weight:600; color:#cbd5e1; }
    .bd { padding:14px 16px; }
    textarea,input,select {
      width:100%; background:#0b1220; border:1px solid rgba(255,255,255,0.08);
      color:var(--text); border-radius:12px; padding:10px 12px; font-size:14px;
    }
    textarea { resize:vertical; min-height:110px; font-family:ui-monospace,SFMono-Regular,Menlo,Monaco; }
    .row3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    label { display:block; font-size:12px; color:var(--muted); margin:10px 2px 6px; }
    button {
      cursor:pointer; border:1px solid rgba(255,255,255,0.12);
      background:linear-gradient(180deg, rgba(56,189,248,0.25), rgba(56,189,248,0.15));
      color:white; border-radius:12px; padding:10px 12px; font-weight:600;
    }
    button.secondary { background:linear-gradient(180deg, rgba(167,139,250,0.2), rgba(167,139,250,0.1)); }
    canvas { width:100%; height:300px; background:#0b1220; border-radius:12px; border:1px solid rgba(255,255,255,0.08); cursor:ew-resize; }
    .strip { display:grid; grid-template-columns:repeat(auto-fill, minmax(6px, 1fr)); gap:2px; }
    .bp { height:18px; border-radius:3px; }
    .stat { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:8px; }
    .pill { background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08);
            padding:8px 10px; border-radius:12px; font-size:13px; text-align:center; }
    .error { color:#fecaca; background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.3);
             padding:8px 10px; border-radius:10px; margin-top:8px; display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>DNA Melting Curve Simulator</h1>
    <div class="sub">Powered by <code>meltingLib.js</code> (shared API-compliant simulation library)</div>

    <div class="grid">
      <div class="card">
        <div class="hd">Inputs</div>
        <div class="bd">
          <label>DNA sequence</label>
          <textarea id="seq" spellcheck="false"></textarea>

          <div class="row3">
            <div><label>[Na⁺] (M)</label><input id="Na" type="number" value="0.05" step="0.001" /></div>
            <div><label>[Mg²⁺] (M)</label><input id="Mg" type="number" value="0.001" step="0.0001" /></div>
            <div><label>Strand conc (M)</label><input id="conc" type="number" value="0.0000005" step="1e-7" /></div>
          </div>

          <div class="row3">
            <div><label>Window size</label><input id="win" type="number" value="15" min="5" max="51" step="2" /></div>
            <div><label>Slope k</label><input id="k" type="number" value="0.8" step="0.05" /></div>
            <div>
              <label>Algorithm</label>
              <select id="mode">
                <option value="independent" selected>Independent</option>
                <option value="posterior">HMM Posterior</option>
                <option value="viterbi">HMM Viterbi</option>
                <option value="thermo">Thermodynamic</option>
                <option value="sigmoid">Sigmoid</option>
                <option value="hmm">Pedagogical HMM</option>
                <option value="transferFast">Transfer Matrix (Fast)</option>
                <option value="transfer">Transfer Matrix (Full)</option>
                <option value="partitionFast">Partition Function (Fast)</option>
                <option value="partition">Partition Function (Full)</option>
              </select>
            </div>
          </div>

          <div class="row3">
            <div><label>Domain L</label><input id="L" type="number" value="20" /></div>
            <div><label>π<sub>M</sub></label><input id="piM" type="number" value="0.5" step="0.01" /></div>
            <div><label>ε</label><input id="eps" type="number" value="1e-6" step="1e-6" /></div>
          </div>

          <div class="row3">
            <div>
                <label>Cooperativity (0–5)</label>
                <input id="coop" type="number" value="1" step="0.1" min="0" max="5" />
            </div>
            <div></div><div></div>
          </div>

          <div style="display:flex;gap:10px;margin-top:10px;">
            <button id="demo">Load demo</button>
            <button class="secondary" id="clear">Clear</button>
          </div>
          <div class="error" id="err"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd">Visualization</div>
        <div class="bd">
          <label>Temperature: <span id="tLabel">70</span>°C</label>
          <canvas id="chart" width="900" height="300"></canvas>
          <div class="stat">
            <div class="pill">Fraction melted: <span id="frac">—</span></div>
            <div class="pill">Median local Tm: <span id="medianTm">—</span></div>
            <div class="pill">Length: <span id="len">—</span></div>
          </div>
          <div class="strip" id="strip"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="meltingLib.js"></script>
  <script>
  const seqEl = document.getElementById('seq');
  const NaEl = document.getElementById('Na');
  const MgEl = document.getElementById('Mg');
  const concEl = document.getElementById('conc');
  const winEl = document.getElementById('win');
  const kEl = document.getElementById('k');
  const modeEl = document.getElementById('mode');
  const LEl = document.getElementById('L');
  const piMEl = document.getElementById('piM');
  const epsEl = document.getElementById('eps');
  const fracEl = document.getElementById('frac');
  const medTmEl = document.getElementById('medianTm');
  const lenEl = document.getElementById('len');
  const tLabel = document.getElementById('tLabel');
  const strip = document.getElementById('strip');
  const chart = document.getElementById('chart');
  const errEl = document.getElementById('err');
  const coopEl = document.getElementById('coop');

  let state = { seq:'', Tmin:20, Tmax:100, currentT:70 };

  const colorMap = {
    independent: '#38bdf8',   // blue
    posterior:   '#22c55e',   // green
    viterbi:     '#f97316',   // orange
    thermo:      '#e11d48'    // red
  };

  function colorForProb(p) {
    const c1=[0x1d,0x4e,0xd8], c2=[0xef,0x44,0x44];
    const mix=c1.map((v,i)=>Math.round(v+(c2[i]-v)*p));
    return `rgb(${mix[0]},${mix[1]},${mix[2]})`;
  }

  function drawStrip(perBaseAtT) {
    strip.innerHTML = '';
    const N = perBaseAtT.length;
    for (let i = 0; i < N; i++) {
        const p = perBaseAtT[i];
        const el = document.createElement('div');
        el.className = 'bp';
        el.style.background = colorForProb(isFinite(p) ? p : 0);
        // Tooltip with base index and probability
        const probText = isFinite(p) ? p.toFixed(3) : '—';
        el.title = `Base ${i + 1}: ${probText}`;
        strip.appendChild(el);
    }
  }

  function drawCurve(fractionFunc, Tmin, Tmax, currentT, mode){
    const ctx=chart.getContext('2d'); const W=chart.width, H=chart.height;
    ctx.clearRect(0,0,W,H);
    // const N=200; // 1 degree resolution

    const N = 800;  // matches the 0.1 degree temperature grid
    ctx.beginPath();
    for(let i=0;i<=N;i++){
      const T=Tmin+(i/N)*(Tmax-Tmin);
      const f=fractionFunc(T);
      const x=40+(W-60)*(i/N); const y=(H-20)-(H-40)*f;
      if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);
    }
    ctx.strokeStyle=colorMap[mode]||'#38bdf8';
    ctx.lineWidth=2; ctx.stroke();
    const xcur=40+(W-60)*((currentT-Tmin)/(Tmax-Tmin));
    ctx.beginPath(); ctx.moveTo(xcur,20); ctx.lineTo(xcur,H-20);
    ctx.strokeStyle='rgba(239,68,68,0.9)'; ctx.setLineDash([4,3]);
    ctx.stroke(); ctx.setLineDash([]);
  }

  function recompute(){
    errEl.style.display='none';
    const seq = melt.Thermo.sanitizeSeq(seqEl.value);
    if(!seq.length){errEl.textContent='Please enter a sequence of A/T/G/C';errEl.style.display='block';return;}
    state.seq=seq; lenEl.textContent=seq.length;
    const Na=+NaEl.value||0.05, Mg=+MgEl.value||0.001, conc=+concEl.value||5e-7;
    const windowSize=+winEl.value||15, k=+kEl.value||0.8;
    const L=+LEl.value||20, piM=+piMEl.value||0.5, eps=+epsEl.value||1e-6;
    // const temps=Array.from({length:81},(_,i)=>20+i);  // for 1 degree resolution
    const temps = Array.from({length:801}, (_, i) => 20 + i * 0.1); // for 0.1 degree resolution
    const mode=modeEl.value;

    const conditions={Na:Na*1000,Mg:Mg*1000,conc};
    const coop = +coopEl.value || 0.05;
    const params={window:windowSize,k,L,piM,eps,cooperativity:coop};
    const options={returnPerBase:true};

    let sim;

    switch(mode){
        case 'posterior':  sim=melt.Simulate.simulateHMMPosterior({sequence:seq,temperatures:temps,conditions,params,options}); break;
        case 'viterbi':    sim=melt.Simulate.simulateHMMViterbi({sequence:seq,temperatures:temps,conditions,params,options}); break;
        case 'thermo':     sim=melt.Simulate.simulateThermodynamic({sequence:seq,temperatures:temps,conditions,params,options}); break;
        case 'sigmoid':    sim=melt.Simulate.simulateSigmoid({sequence:seq,temperatures:temps,params}); break;
        case 'hmm':        sim=melt.Simulate.simulateHMM({sequence:seq,temperatures:temps,conditions,params,options}); break;

        case 'transferFast':
            sim = melt.Simulate.simulateTransferMatrixFast({sequence: seq, temperatures: temps, conditions, params, options});
            break;
        case 'transfer':
            sim = melt.Simulate.simulateTransferMatrix({sequence: seq, temperatures: temps, conditions, params, options});
            break;
        case 'partitionFast':
            sim = melt.Simulate.simulatePartitionFunctionFast({sequence: seq, temperatures: temps, conditions, params, options});
            break;
        case 'partition':
            sim = melt.Simulate.simulatePartitionFunction({sequence: seq, temperatures: temps, conditions, params, options});
            break;

        default:           sim=melt.Simulate.simulateIndependent({sequence:seq,temperatures:temps,conditions,params,options});
    }

    state.sim=sim; state.mode=mode;
    updateVisuals();
  }

  function fractionAtT(T) {
    if (!state.sim) return 0;
    const { temperatures, fractionMelted } = state.sim;
    // const idx=Math.round(T-20); // for 1 degree resolution
    const idx = Math.round((T - 20) * 10);
    return fractionMelted[idx] ?? 0;
  }


  function updateVisuals() {
    const T = state.currentT;
    tLabel.textContent = T.toFixed(1);
    if (!state.sim) return;

    // 1 degree resolution
    // const idx = Math.round(T - 20);
    // const perBaseData = state.sim.perBase?.[idx]; 

    // 0.1 degree resolution
    const idx = Math.round((T - 20) * 10);
    const perBaseData = state.sim.perBase?.[idx];
    let perBaseAtT;

    if (Array.isArray(perBaseData) && perBaseData.length > 0) {
        perBaseAtT = perBaseData;
    } else {
        // Fallback: approximate uniform probability
        const f = fractionAtT(T);
        perBaseAtT = new Array(state.seq.length).fill(f);
    }

    // Update melt map and main curve
    drawStrip(perBaseAtT);
    const f = fractionAtT(T);
    fracEl.textContent = f.toFixed(3);
    drawCurve(fractionAtT, state.Tmin, state.Tmax, T, state.mode);
  }

  // --- event wiring ---
  const recomputeInputs=[seqEl,NaEl,MgEl,concEl,winEl,kEl,LEl,piMEl,epsEl,modeEl];
  recomputeInputs.forEach(el=>{
    el.addEventListener('input',recompute);
    el.addEventListener('change',recompute);
  });

  // --- draggable vertical line ---
  let dragging=false;
  chart.addEventListener('mousedown',e=>{dragging=true;setTFromClientX(e.clientX);});
  window.addEventListener('mousemove',e=>{if(dragging)setTFromClientX(e.clientX);});
  window.addEventListener('mouseup',()=>dragging=false);
  function setTFromClientX(clientX){
    const rect=chart.getBoundingClientRect();
    const x=clientX-rect.left;
    const T=state.Tmin+(x-40)/(chart.width-60)*(state.Tmax-state.Tmin);
    state.currentT=Math.min(state.Tmax,Math.max(state.Tmin,T));
    updateVisuals();
  }

  // --- demo buttons ---
  document.getElementById('demo').onclick=()=>{
    seqEl.value='ATGCGCATTAATCGGATGCCGCTTAGCTAGGCGATATATTTGCGCGCGGATCCGATATGCGCGTATATATGC';
    recompute();
  };
  document.getElementById('clear').onclick=()=>{seqEl.value='';recompute();};

  // initial load
  seqEl.value='ATGCGCATTAATCGGATGCC';
  recompute();
</script>
</body>
</html>