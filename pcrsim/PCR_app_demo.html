<html>
    <head>
        <title>PCR Simulation App Demo</title>
        <script language="javascript" src="Hybridizer.js"></script>
        <script language="javascript" src="PrimerSearcher.js"></script>
        <script language="javascript" src="TEMPLATES.js"></script>  <!-- instantiates global TEMPLATES object -->
        <script language="javascript" src="PCR.js"></script>
        <script language="javascript" src="gel.js"></script>
        <script language="javascript" src="CACHE_PRELOADS.js"></script>
    </head>
    <body>
        <script language="javascript">
            var SEARCHER = new PrimerSearcher();
            var HYBRIDIZER = new Hybridizer();
            var GEL = new Gel();
            
            // aal = SEARCHER.search_primer('NC_000913.3', 'ATGTTCAGCGTTCTGGTC', strand='top', fudge=10);a = aal[0].alignments[0]

            go = function(){
                document.getElementById("status_div").innerHTML = "<b>Running...</b>"
                window.setTimeout(run_PCR_reactions, 1)
            }
            

            var GEL_DATA;
            run_PCR_reactions = function(){
                
                let my_template = new DnaMolecule('NC_000913.3', TEMPLATES['NC_000913.3']) // a sequence where the name refers to another object
                let primerA_seq = document.getElementById('primerA').value
                let primerB_seq = document.getElementById('primerB').value
                let primerA = new DnaMolecule(primerA_seq, primerA_seq) // a verbatim sequence where the sequence is the name
                let primerB = new DnaMolecule(primerB_seq, primerB_seq)   // another verbatim sequence

                let soln1 = new Solution('soln1', volume=10)
                soln1.add_ingredient(my_template, 1e-12)
                soln1.add_ingredient(primerA, 1e-6)
                soln1.add_ingredient(primerB, 1e-6)
                
                let my_pcr1 = new PCR(soln1)

                pcr1_cycles = document.getElementById("pcr1_cycles").value
                pcr1_anneal = 55  // document.getElementById("pcr1_anneal").value
                my_pcr1.run(num_cycles=pcr1_cycles, denaturationTemp=98, annealingTemp=pcr1_anneal)  // run resets the features, so we can do multiple independant runs on the same PCR object.

                let soln2 = new Solution('soln2', volume=10)
                soln2.add_ingredient(my_template, 1e-12)
                soln2.add_ingredient(primerA, 1e-6)
                soln2.add_ingredient(primerB, 1e-6)

                let my_pcr2 = new PCR(soln2)
                pcr2_cycles = document.getElementById("pcr2_cycles").value
                pcr2_anneal = 55 // document.getElementById("pcr2_anneal").value
                my_pcr2.run(num_cycles=pcr2_cycles, denaturationTemp=98, annealingTemp=pcr2_anneal)

                let soln3 = new Solution('soln3', volume=10)
                soln3.add_ingredient(my_template, 1e-12)
                soln3.add_ingredient(primerA, 1e-6)
                soln3.add_ingredient(primerB, 1e-6)

                let my_pcr3 = new PCR(soln3)
                pcr3_cycles = document.getElementById("pcr3_cycles").value
                pcr3_anneal = 55 // document.getElementById("pcr3_anneal").value
                my_pcr3.run(num_cycles=pcr3_cycles, denaturationTemp=98, annealingTemp=pcr3_anneal)
                
                lane1 = my_pcr1.get_band_data()
                lane2 = my_pcr2.get_band_data()
                lane3 = my_pcr3.get_band_data()


                GEL_DATA = [
                    create_marker_band_data(100, 20).map(to_gel_band),
                    lane1.map(to_gel_band),
                    lane2.map(to_gel_band),
                    lane3.map(to_gel_band)
                ]

                document.getElementById("status_div").innerHTML = "<b>Ready!</b>"
            }


        </script>
        <h1>PCR Simulation App Demo</h1>

        <p> For now, all the PCR reactions on the gel will contain the same two primers that you specify below, and the template will be E. coli K12.</p>

        <form>
            Primer A: <textarea id="primerA" rows="1" cols="30">ATGTTCAGCGTTTCTGGTC</textarea> <br />
            Primer B: <textarea id="primerB" rows="1" cols="30">ATCGGTATTGAACAGCAT</textarea> <br />

            <h4>PCR1</h4>
            cycles: <input id="pcr1_cycles" type="text" size="4" value="25" />
            <!-- annealing temperature: <input id="pcr1_anneal" type="text" size="4" value="55" /> -->
            <br />
            <h4>PCR2</h4>
            cycles: <input id="pcr2_cycles" type="text" size="4" value="30" />
            <!-- annealing temperature: <input id="pcr2_anneal" type="text" size="4" value="65" /> -->
            <br />
            <h4>PCR3</h4>
            cycles: <input id="pcr3_cycles" type="text" size="4" value="50" />
            <!-- annealing temperature: <input id="pcr3_anneal" type="text" size="4" value="75" /> -->
            <br />
            <input type="button" value="run PCRs" onclick="go()" />
            <div id="status_div">&nbsp;</div>
            <br />
            <input type="button" value="run gel" onclick="load_svg(GEL_DATA)" />
        </form>
        <div id="gel_display">
         
        </div>

        <p>
            <h2>To Do:</h2>
            <ul>
                <li>Specify both the template name and primer sequence in search_primer(), so that there is only one PRIMER_SEARCHER object.</li>
                <li>keep local TEMPLATES in a dictionary, where every template sequence has a name. The name should be the GenBank accession number. Someday, templates not in the local dictionary will be searched via remote call.</li>
                <li>create AlternativeAlignmentList, AlternativeAlignment, and Alignment objects from data structures that can be easily converted to and from JSON</li>
                <li>cache search_primer() results, and be able to pre-load this cache from a file.</li>
            </ul>

            <h2>Test Code</h2>
            <pre>
SEARCHER.load_cache_from_data_obj(CACHE_PRELOADS)

let primerA_seq = document.getElementById('primerA').value
let primerB_seq = document.getElementById('primerB').value

let aa_list = SEARCHER.search_primer('NC_000913.3', primerB_seq, 'bottom', 10)
// SEARCHER.cache["NC_000913.3::ATCGGTATTGAACAGCAT::bottom::10"]
// JSON.stringify(SEARCHER.cache)
cache_obj = JSON.parse(SEARCHER.export_cache_as_json())

new_searcher = new PrimerSearcher()
new_searcher.load_cache_from_data_obj(cache_obj)
new_searcher.cache


let my_template = new DnaMolecule('NC_000913.3', TEMPLATES['NC_000913.3']) // a sequence where the name refers to another object

let primerA = new DnaMolecule(primerA_seq, primerA_seq)  // a verbatim sequence where the sequence is the name
let primerB = new DnaMolecule(primerB_seq, primerB_seq)  // another verbatim sequence

let soln1 = new Solution('soln1', volume=10)
soln1.add_ingredient(my_template, 1e-12)
soln1.add_ingredient(primerA, 1e-6)
soln1.add_ingredient(primerB, 1e-6)



let my_pcr = new PCR(soln1)
my_pcr.find_template_primer_binding_sites(fudge=10)  // this is slow, so we want to be able to re-use the results
my_pcr.find_potential_products()

pcr1_cycles = document.getElementById("pcr1_cycles").value
pcr1_anneal = 55  // document.getElementById("pcr1_anneal").value
my_pcr.run(num_cycles=pcr1_cycles, denaturationTemp=98, annealingTemp=pcr1_anneal)  // run resets the features, so we can do multiple independant runs on the same PCR object.

my_pcr.potential_products[0].concentration_history
            </pre>
        </p>
    </body>
</html>
